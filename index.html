<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gu√≠a de pasos SAGCOM 2 - Con Clima</title>
<style>
  /* Fondo con imagen y niebla */
  body::before {
    content: "";
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: url('https://raw.githubusercontent.com/halfaro-glitch/Guia-Instructiva-Sagcom-2.0/refs/heads/main/imagen.avif') no-repeat center center fixed;
    background-size: contain;
    filter: brightness(0.95);
    z-index: -3;
  }
  body::after {
    content: "";
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.15) 10%, rgba(255,255,255,0.45) 30%, rgba(255,255,255,0.15) 70%, rgba(255,255,255,0.05) 90%);
    pointer-events: none;
    z-index: -2;
  }

  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    color: #222;
    position: relative;
    z-index: 0;
    background-color: #fff;
  }

  header {
    background: linear-gradient(145deg, #3a006f 0%, #6a0dad 60%, #fff 100%);
    color: white;
    font-weight: bold;
    font-size: 2rem;
    text-align: center;
    padding: 2rem 1rem;
    position: relative;
    letter-spacing: 1px;
    text-shadow: 3px 3px 8px #00000088;
  }
  header .autor-text {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    color: rgba(255,255,255,0.9);
    font-family: Georgia, serif;
    font-weight: 700;
    font-size: 1.1rem;
    user-select: none;
  }

  /* Panel clima/hora izquierda superior */
  #panelClima {
    position: fixed;
    top: 5px;
    left: 5px;
    background: rgba(255 255 255 / 0.85);
    border-radius: 22px;
    padding: 10px 18px;
    box-shadow: 0 2px 12px #6a0dadaa;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #3a006f;
    max-width: 240px;
    z-index: 100;
  }
  #panelClima header {
    font-weight: 700;
    margin-bottom: 6px;
    font-size: 1.12rem;
  }
  #horaActual {
    font-size: 1.4rem;
    font-weight: 900;
    margin-bottom: 6px;
    letter-spacing: 1px;
  }
  #selectorRegion {
    margin-bottom: 8px;
    padding: 6px 10px;
    font-size: 1rem;
    border-radius: 10px;
    border: 2px solid #6a0dad;
    background: #fafafa;
    color: #3a006f;
    cursor: pointer;
  }
  #climaInfo {
    display: flex;
    align-items: center;
  }
  #climaIcon {
    width: 48px;
    height: 48px;
    margin-right: 12px;
    filter: drop-shadow(0 0 3px #6a0dad99);
  }
  #climaTemp {
    font-size: 1.3rem;
    font-weight: 700;
  }
  #climaText {
    font-size: 1rem;
    opacity: 0.8;
  }

  /* Perfil segmentaci√≥n arriba */
  .perfil-filter {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin: 1.5rem auto 0;
    max-width: 1100px;
  }
  .perfil-btn {
    background: linear-gradient(145deg, #6a0dad 0%, #3a006f 90%);
    border-radius: 24px;
    padding: 0.8rem 2.2rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 16px #3a006f77;
    transition: transform 0.28s ease, box-shadow 0.28s ease, background-color 0.3s ease;
    text-shadow: 1px 1px 10px #000000cc;
  }
  .perfil-btn:hover {
    box-shadow: 0 8px 24px #6a0daddd;
    transform: scale(1.1);
  }
  .perfil-btn.active {
    background-color: #52006b;
    box-shadow: 0 10px 28px #6a0dadcc;
    transform: scale(1.15);
  }

  /* Buscar y botones */
  .filters {
    max-width: 1100px;
    margin: 0.8rem auto 2rem auto;
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .filters input[type=search] {
    border: 2px solid #6a0dad;
    border-radius: 10px;
    padding: 0.55rem 1.7rem;
    font-size: 1rem;
    outline: none;
    box-shadow: 0 1px 7px #3a006f21;
    transition: 0.3s box-shadow ease;
    min-width: 180px;
  }
  .filters input[type=search]:focus {
    box-shadow: 0 0 13px #6a0dad77;
    border-color: #3a006f;
  }
  .filters button {
    font-weight: 700;
    padding: 0.5rem 1.3rem;
    border-radius: 12px;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    color: white;
    box-shadow: 0 3px 20px #3a006fcc;
    transition: 0.3s background-color ease;
  }
  #btnReset {
    background-color: #a010d3;
  }
  #btnReset:hover {
    background-color: #68009a;
  }
  #btnWebSearch {
    background-color: #3d84e6;
  }
  #btnWebSearch:hover {
    background-color: #245ea7;
  }

  main {
    max-width: 1100px;
    margin: 0 auto 3rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 20px #3a006f2e;
    padding: 1rem 2rem;
  }
  .content-container {
    display: flex;
    gap: 2rem;
  }
  .perfil-3d {
    font-size: 2.5rem;
    color: #6a0dad;
    font-weight: 900;
    text-shadow: 3px 3px 15px #3a006faa;
    /* efecto 3d */
    transform-style: preserve-3d;
    perspective: 900px;
    cursor: default;
    margin: 0 0 2rem 0;
    user-select: none;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 18px;
    background: linear-gradient(145deg, #fdf6ff, #bb9edc);
    box-shadow:
      0 6px 15px #7854ebaa,
      inset 0 -3px 8px #a095d1a1,
      inset 0 6px 6px #7b65c89a;
  }
  .subtitulo-container, .accion-container {
    border: 2px solid #6a0dad;
    border-radius: 16px;
    padding: 1rem 1.3rem;
  }
  .subtitulo-container {
    width: 300px;
    max-height: 600px;
    overflow-y: auto;
    background: #f2eeff;
    font-weight: 600;
    font-size: 1rem;
    color: #3a006f;
  }
  .subtitulo-container h3 {
    margin: 0 0 12px 0;
    font-weight: 800;
    color: #6a0dad;
    font-size: 1.3rem;
    border-bottom: 2px solid #6a0dad;
    padding-bottom: 6px;
    user-select:none;
  }
  .subtitulo-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .subtitulo-list li {
    padding: 0.55rem 0.8rem;
    margin-bottom: 5px;
    cursor: pointer;
    border-radius: 12px;
    transition: background-color 0.28s ease, color 0.28s ease;
  }
  .subtitulo-list li:hover, .subtitulo-list li.selected {
    background-color: #6a0dad;
    color: white;
    font-weight: 700;
  }
  .accion-container {
    flex-grow: 1;
    background: #fcfbfd;
    min-height: 180px;
    font-weight: 600;
    font-size: 1.12rem;
    color: #4a037d;
  }
  .accion-container h3 {
    font-weight: 900;
    font-size: 1.5rem;
    color: #6a0dad;
    margin-bottom: 12px;
  }
  .accion-text {
    white-space: pre-line;
    padding-left: 1rem;
  }
  @media (max-width: 900px) {
    .content-container {
      flex-direction: column;
    }
    .subtitulo-container,
    .accion-container {
      width: 100%;
      max-height: none;
    }
  }
</style>
</head>
<body>
<header>
  Gu√≠a de pasos para SAGCOM 2
  <div class="autor-text">Creado por H√©ctor Alfaro M.</div>
</header>

<div id="panelClima" aria-label="Panel clima e informaci√≥n actual">
  <header>Clima y Hora</header>
  <div id="horaActual">--:--:--</div>
  <select id="selectorRegion" aria-label="Seleccionar regi√≥n de Chile para ver clima">
    <option value="" disabled selected>Seleccione regi√≥n</option>
    <option value="Arica">Arica</option>
    <option value="Iquique">Iquique</option>
    <option value="Antofagasta">Antofagasta</option>
    <option value="Copiapo">Copiap√≥</option>
    <option value="La Serena">La Serena</option>
    <option value="Los Andes">Los Andes</option>
    <option value="Vi√±a del Mar">Vi√±a del Mar</option>
    <option value="Casa Matriz">Casa Matriz (Santiago)</option>
    <option value="Rancagua">Rancagua</option>
    <option value="Talca">Talca</option>
    <option value="Chillan">Chill√°n</option>
    <option value="Concepcion">Concepci√≥n</option>
    <option value="Lo Angeles">Lo Angeles</option>
    <option value="Temuco">Temuco</option>
    <option value="Valdivia">Valdivia</option>
    <option value="Osorno">Osorno</option>
    <option value="Puerto Montt">Puerto Montt</option>
    <option value="Chiloe">Chilo√©</option>
    <option value="Coyhaique">Coyhaique</option>
    <option value="Punta Arenas">Punta Arenas</option>
  </select>
  <div id="climaInfo" aria-live="polite" role="region" style="margin-top:6px;">
    <img id="climaIcon" alt="Icono clima" src="" />
    <div>
      <div id="climaTemp">-- ¬∞C</div>
      <div id="climaText">Elija una regi√≥n para ver el clima</div>
    </div>
  </div>
</div>

<div class="perfil-filter" id="perfilFilter" aria-label="Filtros por perfiles"></div>

<div class="filters">
  <input type="search" id="searchInput" placeholder="Filtrar texto/acci√≥n..." aria-label="Filtrar acciones" />
  <button id="btnReset" title="Borrar filtros">Borrar filtros</button>
  <button id="btnWebSearch" title="Buscar en sitio web oficial">Buscar en spensiones.cl</button>
</div>

<main>
  <div class="content-container">
    <section class="subtitulo-container" aria-label="Tareas de perfil seleccionado">
      <div class="perfil-3d" id="perfil3d">Seleccione un perfil</div>
      <h3>Tareas</h3>
      <nav class="subtitulo-list" id="subtituloList">
        <ul></ul>
      </nav>
    </section>
    <section class="accion-container" aria-label="Acci√≥n a realizar para subtitulo">
      <h3>Acci√≥n a realizar</h3>
      <div class="accion-text" id="accionDisplay" tabindex="0" aria-live="polite"></div>
    </section>
  </div>
</main>

<script>
// Iconos simples para clima, se pueden mejorar seg√∫n API real o im√°genes
const iconosClima = {
  'clear-day': '‚òÄÔ∏è',
  'clear-night': 'üåô',
  'rain': 'üåßÔ∏è',
  'snow': '‚ùÑÔ∏è',
  'sleet': 'üå®Ô∏è',
  'wind': 'üå¨Ô∏è',
  'fog': 'üå´Ô∏è',
  'cloudy': '‚òÅÔ∏è',
  'partly-cloudy-day': '‚õÖ',
  'partly-cloudy-night': 'üå•Ô∏è'
};

function actualizarHora() {
  const horaCont = document.getElementById("horaActual");
  setInterval(() => {
    const ahora = new Date();
    const h = ahora.getHours().toString().padStart(2, '0');
    const m = ahora.getMinutes().toString().padStart(2, '0');
    const s = ahora.getSeconds().toString().padStart(2, '0');
    horaCont.textContent = `${h}:${m}:${s}`;
  }, 1000);
}

async function obtenerClimaChile(region) {
  // Aqu√≠ hace llamada a API de clima real si tienes clave y endpoint,
  // si no, simulamos resultados simples para demo con random entre opciones

  if(!region) return null;

  // Simulaci√≥n de resultados seg√∫n region (prueba local)
  const condicionesDemostrativas = [
    {icon:'clear-day', temp:23, texto:'Soleado'},
    {icon:'partly-cloudy-day', temp:18, texto:'Parcialmente nublado'},
    {icon:'rain', temp:14, texto:'Lluvia ligera'},
    {icon:'fog', temp:12, texto:'Niebla'},
    {icon:'cloudy', temp:15, texto:'Nublado'},
  ];
  const seleccion = condicionesDemostrativas[Math.floor(Math.random()*condicionesDemostrativas.length)];
  return seleccion;

  // Ejemplo real se har√≠a con fetch, endpoint real y clave:
  /*
  const apiKey = 'TU_API_KEY';
  const url = `https://api.climatempo.com/location/${region}/weather?apikey=${apiKey}`;
  let response = await fetch(url);
  if(!response.ok) throw new Error("Error al obtener clima");
  let data = await response.json();
  // Procesar data seg√∫n estructura API alocado
  */
}

document.addEventListener('DOMContentLoaded', () => {
  actualizarHora();

  const pasos = [
    {perfil: "ADMINISTRATIVO", subtitulo: "ANALISIS DE ADMISIBILIDAD", accion:"VER + / REGULAR / BUSCAR RUT / VER +"},
    {perfil: "ADMINISTRATIVO", subtitulo: "ADMISIBILIDAD DE LA SOLICITUD", accion:"ACEPTAR / CONFIRMAR"},
    {perfil: "M√âDICO PRESIDENTE", subtitulo: "ASIGNAR MEDICO", accion:"REGULAR / BUSCAR RUT"},
    {perfil: "M√âDICO PRESIDENTE", subtitulo: "ACCIONES / AUTOASIGNAR Y/O MODIFICAR", accion:""},
    {perfil: "M√âDICO PRESIDENTE", subtitulo: "MARCAR M√âDICO / CONFIRMAR M√âDICO", accion:""},
    {perfil: "ADMINISTRATIVO", subtitulo: "INICIO / CITACIONES", accion:"VER + / REGULAR / BUSCAR RUT"},
    {perfil: "ADMINISTRATIVO", subtitulo: "ACCIONES / REAGENDAR 1 O 2 SOLICITUDES", accion:"(DEPENDE EL CASO)"},
    {perfil: "ADMINISTRATIVO", subtitulo: "GESTIONAR CITACION / PREVISUALIZAR CARTA", accion:"CONFIRMAR CITA"},
    {perfil: "ADMINISTRATIVO", subtitulo: "‚Ä¶ NOMINA DE CORREO", accion:"MARCAR SOLICITUDES / ASIGNAR N√ìMINA / CREAR"},
    {perfil: "ADMINISTRATIVO", subtitulo: "N√ìMINA / EN GESTION", accion:"SE PINCHA LA 1ERA / REVISAR NOMINA"},
    {perfil: "ADMINISTRATIVO", subtitulo: "DESCARGAR DOCUMENTO N√ìMINA", accion:""},
    {perfil: "ADMINISTRATIVO", subtitulo: "GUIA DE DESPACHO DE CORREOS", accion:"EDITAR No DE N√ìMINA"},
    {perfil: "ADMINISTRATIVO", subtitulo: "DOCUMENTO GUIA DE DESPACHO", accion:"CAMBIAR FECHA (HOY) / ADJUNTAR N√ìMINA / GUARDAR"},
    {perfil: "ADMINISTRATIVO", subtitulo: "INICIO", accion:"CONFIRMAR ASISTENCIA A EVALUACIONES"},
    {perfil: "ADMINISTRATIVO", subtitulo: "CONFIRMAR ASISTENCIA A EVALUACIONES", accion:"PRESENCIAL / TELEFONICA"},
    {perfil: "ADMINISTRATIVO", subtitulo: "BUSCAR C/ RUT / ACCIONES", accion:"SOBRECUPO / CAMBIAR HORA / CONFIRMAR / SI (X 2)"},
    {perfil: "ADMINISTRATIVO", subtitulo: "VER +", accion:"REGULAR / BUSCAR RUT / VER +"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "MIS EXPEDIENTES", accion:"EVALUACI√ìN M√âDICA"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "PENDIENTE DE INICIO / EN EVALUACION", accion:"BUSCAR RUT / IR AL EXPEDIENTE"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "DESEA REALIZAR EVALUACION MEDICA?", accion:"COMENZAR"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "ANAMNESIS", accion:"COMPLETAR / GUARDAR"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "EXAMEN F√çSICO", accion:"COMPLETAR / GUARDAR"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "PLAN DE ACCI√ìN", accion:"ACCI√ìN A SEGUIR / PERITAJES Y/O EXAMENES"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "NUEVA SOLICITUD", accion:""},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "SOLICITAR INTERCONSULTAS", accion:"ESPECIALIDADES (‚Ä¶..) SELECCIONAR"},
    {perfil: "M√âDICO ASIGNADO", subtitulo: "SOLICITAR EXAMENES", accion:"EXAMENES DE LABORATORIO / FILTRAR / CONFIRMAR"},
    {perfil: "ADMINISTRATIVO", subtitulo: "ORDENES DE ATENCI√ìN POR GESTIONAR", accion:"VER + / REGULAR / BUSCAR RUT"},
    {perfil: "ADMINISTRATIVO", subtitulo: "GESTIONAR ORDEN", accion:"SELECCIONAR COMISION / PROPUESTA DE SISTEMA N¬∞ 1"},
    {perfil: "ADMINISTRATIVO", subtitulo: "LABORATORIO VERIS", accion:""},
    {perfil: "ADMINISTRATIVO", subtitulo: "INTERCONSULTA SOLICITADA", accion:"COMPLETAR / ACCIONES / MODALIDAD DE ATENCION"},
    {perfil: "ADMINISTRATIVO", subtitulo: "CAMBIAR FECHA / HORA", accion:""},
    {perfil: "ADMINISTRATIVO", subtitulo: "SELECCIONAR INTERCONSULTOR (POR DEFECTO)", accion:""},
    {perfil: "ADMINISTRATIVO", subtitulo: "AGENDAR / CONFIRMAR / EMITIR ORDENES", accion:""},
    {perfil: "M√âDICO INTERCONSULTOR", subtitulo: "...√ìRDENES DE ATENCI√ìN", accion:""},
    {perfil: "M√âDICO INTERCONSULTOR", subtitulo: "√ìRDENES EMITIDAS", accion:"FILTRAR CON RUT / SELECCIONAR, CONFIRMAR"},
    {perfil: "M√âDICO INTERCONSULTOR", subtitulo: "CONFIRMAR C/RUT/ INDICAR HORA / ACEPTAR", accion:""},
    {perfil: "M√âDICO INTERCONSULTOR", subtitulo: "ORDENES CONFIRMADAS", accion:"SELECCIONAR / REALIZAR EVALUACI√ìN"},
    {perfil: "M√âDICO INTERCONSULTOR", subtitulo: "ADJUNTAR INFORME FINAL / ENV√çAR A REVISI√ìN", accion:""},
    {perfil: "LABORATORIO", subtitulo: "√ìRDENES EMITIDAS", accion:"FILTRAR CON RUT / SELECCIONAR, CONFIRMAR"},
    {perfil: "LABORATORIO", subtitulo: "CONFIRMAR C/RUT/ INDICAR HORA / ACEPTAR", accion:""},
    {perfil: "LABORATORIO", subtitulo: "√ìRDENES CONFIRMADAS", accion:"SELECCIONAR / REALIZAR EVALUACI√ìN"},
    {perfil: "LABORATORIO", subtitulo: "DOCUMENTOS DE PRESTACIONES", accion:"ADJUNTAR / ACEPTAR / ENV√çAR A REVISI√ìN / ACEPTAR"},
    {perfil: "ADMINISTRATIVO", subtitulo: "√ìRDENES DE ATENCI√ìN", accion:"ORDENES DE ATENCI√ìN TRABAJADAS"},
    {perfil: "ADMINISTRATIVO", subtitulo: "EN VERIFICACI√ìN DE RECEPCI√ìN", accion:"ACCIONES /VALIDAR PARA COBRO / ACEPTAR"},
    {perfil: "M√âDICO INTERCONSULTOR", subtitulo: "ORDENES VALIDADAS PARA COBRO", accion:"FILTRAR C/ RUT / SELECCIONAR / COBRAR"},
    {perfil: "M√âDICO ASESOR", subtitulo: "MI TRABAJO", accion:"EVALUACI√ìN MEDICA"},
    {perfil: "M√âDICO ASESOR", subtitulo: "PENDIENTE INICIO / EN EVALUACI√ìN", accion:"FILTRAR C/RUT / IR AL EXPEDIENTE"},
    {perfil: "M√âDICO ASESOR", subtitulo: "GESTI√ìN DEL EXPEDIENTE", accion:""},
    {perfil: "M√âDICO ASESOR", subtitulo: "DESEA REALIZAR ENTREVISTA MEDICA?", accion:"COMENZAR / ENTREVISTA CON MEDICO ASESOR"},
    {perfil: "M√âDICO ASESOR", subtitulo: "REALIZAR LA ENTREVISTATELEFONICA? / SI", accion:"COMENZAR"},
    {perfil: "M√âDICO ASESOR", subtitulo: "COMPLETAR IMPEDIMENTOS / AGREGAR", accion:""},
    {perfil: "M√âDICO ASESOR", subtitulo: "COMPLETAR TRATAMIENTO / AGREGAR", accion:""},
    {perfil: "M√âDICO ASESOR", subtitulo: "SOLICITUD INFUNDADA", accion:"SI, SI, SI , A LAS PREGUNTAS."},
    {perfil: "M√âDICO ASESOR", subtitulo: "FINALIZAR / GENERAR PDF", accion:""}
  ];

  function unificarPerfil(p) {
    const pf = p.toLowerCase();
    if(pf.includes("medico presidente")) return "M√©dico Presidente";
    if(pf.includes("medico asignado")) return "M√©dico Asignado";
    if(pf.includes("medico interconsultor")) return "M√©dico Interconsultor";
    if(pf.includes("medico asesor")) return "M√©dico Asesor";
    if(pf.includes("medico designado")) return "M√©dico Designado";
    if(pf.includes("administrativo")) return "Administrativo";
    return p;
  }
  const perfilMap = {};
  pasos.forEach(p => {
    const pu = unificarPerfil(p.perfil);
    if(!perfilMap[pu]) perfilMap[pu] = [];
    if(!perfilMap[pu].includes(p.perfil)) perfilMap[pu].push(p.perfil);
  });

  const perfilFilterDiv = document.getElementById("perfilFilter");
  const subtituloListUl = document.getElementById("subtituloList").querySelector("ul");
  const accionDisplay = document.getElementById("accionDisplay");
  const searchInput = document.getElementById("searchInput");
  const btnReset = document.getElementById("btnReset");
  const btnWebSearch = document.getElementById("btnWebSearch");
  const perfil3D = document.getElementById("perfil3d");
  const selectorRegion = document.getElementById("selectorRegion");
  const climaIcon = document.getElementById("climaIcon");
  const climaTemp = document.getElementById("climaTemp");
  const climaText = document.getElementById("climaText");

  let perfilActual = null;

  function limpiarSeleccion() {
    accionDisplay.textContent = "";
    subtituloListUl.querySelectorAll("li").forEach(li => li.classList.remove("selected"));
  }

  function actualizarPanelClima(region) {
    if(!region) {
      climaIcon.textContent = "";
      climaTemp.textContent = "-- ¬∞C";
      climaText.textContent = "Elija una regi√≥n para ver el clima";
      return;
    }
    // Simular llamada a API clima
    const condicionesDemostrativas = [
      {icon:'‚òÄÔ∏è', temp:23, texto:'Soleado'},
      {icon:'‚õÖ', temp:18, texto:'Parcialmente nublado'},
      {icon:'üåßÔ∏è', temp:14, texto:'Lluvia ligera'},
      {icon:'üå´Ô∏è', temp:12, texto:'Niebla'},
      {icon:'‚òÅÔ∏è', temp:15, texto:'Nublado'},
    ];
    const seleccion = condicionesDemostrativas[Math.floor(Math.random()*condicionesDemostrativas.length)];
    climaIcon.textContent = seleccion.icon;
    climaTemp.textContent = `${seleccion.temp} ¬∞C`;
    climaText.textContent = `${region}: ${seleccion.texto}`;
  }

  function actualizarHora() {
    setInterval(() => {
      const ahora = new Date();
      const h = ahora.getHours().toString().padStart(2,'0');
      const m = ahora.getMinutes().toString().padStart(2,'0');
      const s = ahora.getSeconds().toString().padStart(2,'0');
      document.getElementById("horaActual").textContent = `${h}:${m}:${s}`;
    }, 1000);
  }

  function cargarSubtitulos(arrayPerfiles) {
    subtituloListUl.innerHTML = "";
    if(!arrayPerfiles || arrayPerfiles.length === 0) return;

    let subtitulosSet = new Set();
    arrayPerfiles.forEach(po => {
      pasos.filter(p => p.perfil === po).forEach(p => {
        subtitulosSet.add(p.subtitulo);
      });
    });

    let subtitulosArr = Array.from(subtitulosSet).sort();

    const filtro = searchInput.value.trim().toLowerCase();
    if(filtro) {
      subtitulosArr = subtitulosArr.filter(s => {
        return arrayPerfiles.some(po =>
          pasos.some(p => p.perfil === po && p.subtitulo === s && (p.subtitulo + p.accion).toLowerCase().includes(filtro))
        );
      });
    }
    if(!perfilActual && filtro) {
      // Buscar global sin perfil seleccionado
      let globalSet = new Set();
      pasos.forEach(p => {
        if( (p.subtitulo + p.accion).toLowerCase().includes(filtro)) {
          globalSet.add(p.subtitulo);
        }
      });
      subtitulosArr = Array.from(globalSet).sort();
    }

    if(subtitulosArr.length === 0) {
      subtituloListUl.innerHTML = '<li style="text-align:center;color:#6a0dad;">No hay tareas</li>';
      accionDisplay.textContent = "";
      return;
    }

    subtitulosArr.forEach(subt => {
      const li = document.createElement("li");
      li.textContent = subt;
      li.tabIndex = 0;
      li.setAttribute("role", "button");
      li.setAttribute("aria-pressed", "false");
      li.onclick = () => seleccionarSubtitulo(subt, li, arrayPerfiles);
      li.onkeydown = e => {
        if(e.key === "Enter" || e.key === " ") {
          seleccionarSubtitulo(subt, li, arrayPerfiles);
          e.preventDefault();
        }
      };
      subtituloListUl.appendChild(li);
    });
    limpiarSeleccion();
  }

  function seleccionarSubtitulo(subtitulo, liElem, arrayPerfiles) {
    subtituloListUl.querySelectorAll("li").forEach(li => li.classList.remove("selected"));
    liElem.classList.add("selected");

    let acciones = [];
    if(perfilActual) {
      arrayPerfiles.forEach(perf => {
        acciones = acciones.concat(pasos.filter(p => p.perfil === perf && p.subtitulo === subtitulo)
          .map(p => p.accion)
          .filter(a => a && a.trim() !== ""));
      });
    } else {
      acciones = pasos.filter(p => p.subtitulo === subtitulo).map(p => p.accion).filter(a => a && a.trim() !== "");
    }
    acciones = [...new Set(acciones)];
    if(acciones.length === 0) {
      accionDisplay.textContent = "Sin acciones asociadas.";
    } else {
      accionDisplay.innerHTML = acciones.map(a => `‚Ä¢ ${a}`).join("\n");
    }
    accionDisplay.focus();
  }

  actualizarHora();

  Object.keys(perfilMap).forEach(perfUni => {
    const btn = document.createElement("button");
    btn.className = "perfil-btn";
    btn.textContent = perfUni;
    btn.dataset.perfil = perfUni;
    btn.onclick = () => {
      if(perfilActual === perfUni) {
        perfilActual = null;
        btn.classList.remove("active");
        perfil3D.textContent = "Seleccione un perfil";
        cargarSubtitulos([]);
        limpiarSeleccion();
      } else {
        perfilActual = perfUni;
        document.querySelectorAll(".perfil-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        perfil3D.textContent = perfUni; // Mostrar en 3D a la izquierda
        cargarSubtitulos(perfilMap[perfUni]);
        limpiarSeleccion();
      }
    };
    perfilFilterDiv.appendChild(btn);
  });

  btnReset.onclick = () => {
    perfilActual = null;
    limpiarSeleccion();
    perfil3D.textContent = "Seleccione un perfil";
    subtituloListUl.innerHTML = "";
    accionDisplay.textContent = "";
    searchInput.value = "";
    document.querySelectorAll(".perfil-btn").forEach(b => b.classList.remove("active"));
  };

  searchInput.addEventListener("input", () => {
    if(perfilActual){
      cargarSubtitulos(perfilMap[perfilActual]);
    } else {
      cargarSubtitulos([]);
    }
    limpiarSeleccion();
  });

  btnWebSearch.onclick = () => {
    window.open("https://www.spensiones.cl/portal/compendio/596/w3-propertyvalue-3208.html", "_blank");
  };

  selectorRegion.addEventListener("change", async (e) => {
    const region = e.target.value;
    actualizarPanelClima(region);
  });

});
</script>
</body>
</html>
